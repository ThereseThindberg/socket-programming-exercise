import socket
import sys


is_on = False
channels = 10
current_channel = 1

def create_socket():
    return socket.socket(socket.AF_INET, socket.SOCK_STREAM)

#associate socket with address of server
def bind_socket(sock,host,port):
    sock.bind((host,port))

def listen_for_connection(sock):
    sock.listen()
    #printing ip adress and portnumber of server
    print(f"Server listening on {sock.getsockname()}")  

def accept_connection(sock):
    conn,addr=sock.accept()
    print(f"Connected with {addr}")
    return conn,addr

def receive_command(conn):
    try:
        data=conn.recv(1024)
        if not data:
            return None
        return data.decode().strip()
    except:
        return "error during communication"

def close_socket(sock):
    sock.close()
    print("Server is closed")

def tv_menu():
    return(
        "Supported commands:\n"
            "- version\n"
            "- turn_on\n"
            "- turn_off\n"
            "- status\n"
            "- get_channel\n"
            "- get_channels\n"
            "- set_channel <number>\n"
            "- help\n"

    )
#For handeling commands in different versions
def handle_command(command:str):
    global is_on, current_channel, channels
    """
    Support verion, echo, and basic calculator commands
    """

    parts = command.strip().split(" ", 1)   
    if not parts or not parts[0].strip(): 
        return ""     #tom komando gir ingen respons
    
    cmd=parts[0].lower()
    args = parts[1] if len(parts) > 1 else ""


    
    if not is_on and cmd != "turn_on": 
        return "TV is off. Only command allowed is turn_on"

    if cmd=="version":
        return "TCP TV v1.0"

    #Endret kode
    elif cmd == "turn_on":
        is_on = True
        return "TV turned ON\n" + tv_menu()

    elif cmd == "turn_off":
        is_on = False
        return "TV turned OFF"

    elif cmd == "status":
        return "ON" if is_on else "OFF"

    elif cmd == "get_channel":
        if not is_on:
            return "TV is OFF"
        return f"Current channel: {current_channel}"

    elif cmd == "get_channels":
        if not is_on:
            return "TV is OFF"
        return f"Total channels: {channels}"

    elif cmd == "set_channel":  #vis tv ikke er på, returner at den er av
        if not is_on:
            return "TV is OFF"
        if not args.isdigit():   #sjekker om argumentet etter komandoen er et tall for å bytte kanal
            #isdigit er python komando som returnerer true vis det er tall og false ellers
            return "Usage: set_channel <number>"
        c = int(args)   #gjør om "3" til heltall
        if 1 <= c <= channels:  #er kanalnummeret mellom 1 og antall kanaler? 11?
            current_channel = c  #setter til nye kanalen, når tven skrur seg av vil dette bli husket
            return f"Channel set to {current_channel}"
        else:
            return f"Invalid channel. Allowed: 1-{channels}"
    
    elif cmd == "help":
        return tv_menu()

    
    else:
        return "Error: Unknown command"


#Trenger ikke regne ut noe så disse funksjonene kan slettes
def handle_add(args):
    try:
        number=args.split()
        if len(number)!=2:
            return "Error:Expected 2 arguments"
        x=int(number[0])
        y=int(number[1])
        result=x+y
        return str(result)
    except:
        return "Error:Invalid argements"

def handle_sub(args):
    try:
        number=args.split()
        if len(number)!=2:
            return "Error:Expected 2 arguments"
        x=int(number[0])
        y=int(number[1])
        result=x-y
        return str(result)
    except:
        return "Error:Invalid argements"

def handle_mul(args):
    try:
        number=args.split()
        if len(number)!=2:
            return "Error:Expected 2 arguments"
        x=int(number[0])
        y=int(number[1])
        result=x*y
        return str(result)
    except:
        return "Error:Invalid argements"

def handle_div(args):
    try:
        number=args.split()
        if len(number)!=2:
            return "Error:Expected 2 arguments"
        x=int(number[0])
        y=int(number[1])
        result=x/y
        return str(result)
    except:
        return "Error:Invalid argements"

#Communicate with the client
def handle_client(conn):
    try:
        while True:
            data=conn.recv(1024)
            if not data:
                break
            command = data.decode()
            result = handle_command(command)
            conn.sendall(result.encode())
    except Exception as e:
        print("Error during client communication:", e)

def main():
    host = '127.0.0.1'
    port= int(sys.argv[1]) if len(sys.argv) > 1 else 1238
    server_socket=create_socket()
    try: 
        bind_socket(server_socket,host,port)
        listen_for_connection(server_socket)
        conn,addr=accept_connection(server_socket)   #accepting one connection at a time
        print(f"Server connected with{addr}")
        conn.sendall(b"TV is off. only command allowed id turn_on\n")
        while True:
            command=receive_command(conn)   
            if not command or command.lower()=="turn_off":
                conn.sendall(b"The TV is turned off, Goodbye!\n")
                break
            response=handle_command(command)
            conn.sendall((response).encode())
    except:
        print("Server error")
    finally:
        close_socket(server_socket)

if __name__ =="__main__":
    main()

    